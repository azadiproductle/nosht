language: python

addons:
  postgresql: '9.6'

services:
- postgresql
- redis-server
- docker

python:
- '3.6'

cache:
  pip: true
  directories:
    - $HOME/dcache

before_cache:
# Save tagged docker images
- >
  mkdir -p $HOME/docker && docker images -a --format '{{.ID}}' |
  xargs -n 2 -t sh -c 'test -e $HOME/dcache/$1.tar.gz || docker save $0 | gzip -2 > $HOME/dcache/$1.tar.gz'

install:
- if [[ -d $HOME/dcache ]]; then ls $HOME/dcache/*.tar.gz | xargs -I {file} sh -c "zcat {file} | docker load"; fi
- pip install -U pip setuptools
- make install

script:
- make lint
- make test
- make build

after_success:
- ls -lha
- cp py/setup.cfg .
- bash <(curl -s https://codecov.io/bash)
